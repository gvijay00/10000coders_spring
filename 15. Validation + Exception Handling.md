

# ğŸŒŸ **Spring Security + JWT Integration Real Project**

**Goal:**
Students will learn how to:

âœ” Secure API endpoints
âœ” Implement Login using JWT
âœ” Validate token for each request
âœ” Use filters (OncePerRequestFilter)
âœ” Connect JWT Auth with Database Users

---

# ğŸŸ¦ **1. Project Structure (Very Important)**

Your **real project** must have these packages:

```
com.project
 â”œâ”€â”€ config
 â”œâ”€â”€ controller
 â”œâ”€â”€ entity
 â”œâ”€â”€ repository
 â”œâ”€â”€ service
 â”œâ”€â”€ security
 â”‚     â”œâ”€â”€ JwtAuthFilter
 â”‚     â”œâ”€â”€ JwtUtil
 â”‚     â”œâ”€â”€ CustomUserDetails
 â”‚     â”œâ”€â”€ CustomUserDetailsService
 â””â”€â”€ dto
```

---

# ğŸŸ© **2. Add Security + JWT Dependencies**

### **pom.xml**

```xml
<!-- Spring Security -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
```

---

# ğŸŸ§ **3. Create User Entity (with Roles)**

```java
@Entity
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String username;
    private String password;
    private String role;   // ADMIN or USER
}
```

---

# ğŸŸª **4. Create UserRepository**

```java
public interface UserRepository extends JpaRepository<User, Integer> {
    User findByUsername(String username);
}
```

---

# ğŸŸ¥ **5. Create Custom UserDetails (Security User)**

```java
public class CustomUserDetails implements UserDetails {

    private User user;

    public CustomUserDetails(User user) {
        this.user = user;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(() -> "ROLE_" + user.getRole());
    }

    @Override
    public String getPassword() { return user.getPassword(); }

    @Override
    public String getUsername() { return user.getUsername(); }

    @Override
    public boolean isAccountNonExpired() { return true; }

    @Override
    public boolean isAccountNonLocked() { return true; }

    @Override
    public boolean isCredentialsNonExpired() { return true; }

    @Override
    public boolean isEnabled() { return true; }
}
```

---

# ğŸŸ¦ **6. Create CustomUserDetailsService**

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {

    @Autowired
    private UserRepository repo;

    @Override
    public UserDetails loadUserByUsername(String username) {
        User user = repo.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("User Not Found");
        }
        return new CustomUserDetails(user);
    }
}
```

---

# ğŸŸ© **7. Create JWT Utility Class**

```java
@Component
public class JwtUtil {

    private String secret = "mysecretkey";

    public String generateToken(String username) {
        return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + 24*60*60*1000))
                .signWith(SignatureAlgorithm.HS256, secret)
                .compact();
    }

    public String extractUsername(String token) {
        return Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody()
                .getSubject();
    }

    public boolean validateToken(String token, UserDetails userDetails) {
        return extractUsername(token).equals(userDetails.getUsername());
    }
}
```

---

# ğŸŸ§ **8. Create JWT Filter (Very Important)**

Every request must pass through this filter.

```java
@Component
public class JwtAuthFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private CustomUserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        String authHeader = request.getHeader("Authorization");

        String token = null;
        String username = null;

        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            token = authHeader.substring(7);
            username = jwtUtil.extractUsername(token);
        }

        if (username != null &&
                SecurityContextHolder.getContext().getAuthentication() == null) {

            UserDetails userDetails = userDetailsService.loadUserByUsername(username);

            if (jwtUtil.validateToken(token, userDetails)) {

                UsernamePasswordAuthenticationToken authToken =
                        new UsernamePasswordAuthenticationToken(
                                userDetails, null, userDetails.getAuthorities());

                authToken.setDetails(
                        new WebAuthenticationDetailsSource().buildDetails(request)
                );

                SecurityContextHolder.getContext().setAuthentication(authToken);
            }
        }

        filterChain.doFilter(request, response);
    }
}
```

---

# ğŸŸ¥ **9. Create AuthenticationController (Login API)**

```java
@RestController
public class AuthController {

    @Autowired
    private AuthenticationManager authManager;

    @Autowired
    private JwtUtil jwtUtil;

    @Autowired
    private CustomUserDetailsService userDetailsService;

    @PostMapping("/login")
    public String login(@RequestBody User user) {

        Authentication authentication =
                authManager.authenticate(
                        new UsernamePasswordAuthenticationToken(
                                user.getUsername(),
                                user.getPassword()
                        )
                );

        if (authentication.isAuthenticated()) {
            return jwtUtil.generateToken(user.getUsername());
        }

        throw new RuntimeException("Invalid credentials");
    }
}
```

---

# ğŸŸ¦ **10. Security Configuration (Main Part)**

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Autowired
    private JwtAuthFilter jwtAuthFilter;

    @Autowired
    private CustomUserDetailsService userDetailsService;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        return http
                .csrf(csrf -> csrf.disable())
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/login", "/register").permitAll()
                        .requestMatchers("/admin/**").hasRole("ADMIN")
                        .requestMatchers("/user/**").hasRole("USER")
                        .anyRequest().authenticated()
                )
                .userDetailsService(userDetailsService)
                .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class)
                .build();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config)
            throws Exception {
        return config.getAuthenticationManager();
    }

    @Bean
    public PasswordEncoder encoder() {
        return new BCryptPasswordEncoder();
    }
}
```

---

# ğŸŸ§ **11. Create Register API (Hash Password)**

```java
@PostMapping("/register")
public User register(@RequestBody User user) {
    user.setPassword(new BCryptPasswordEncoder().encode(user.getPassword()));
    return repo.save(user);
}
```

---

# â­ **12. TESTING THE WORKFLOW (Very Important)**

### **Step 1: Register User**

```
POST /register
```

Body:

```json
{
  "username": "kumar",
  "password": "1234",
  "role": "ADMIN"
}
```

---

### **Step 2: Login**

```
POST /login
```

Response â†’ JWT Token
Copy it.

---

### **Step 3: Access Protected API**

```
GET /admin/data
```

Add header:

```
Authorization: Bearer <your token>
```

âœ” If ADMIN â†’ allowed
âœ˜ If USER â†’ forbidden

---

# ğŸ“ **ASSIGNMENTS**

### **Task 1:**

Add new role **MANAGER** and secure API:

```
/manager/info
```

### **Task 2:**

Store tokens in a database table for logout functionality.

### **Task 3:**

Add endpoint:

```
/me
```

Return:

* username
* roles
* token expire time

